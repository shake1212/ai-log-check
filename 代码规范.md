# 代码规范

## 1. 前端代码规范

### 1.1 文件命名规范
```
组件文件: PascalCase (如: UserProfile.tsx)
页面文件: kebab-case (如: user-profile/index.tsx)
工具文件: camelCase (如: utils.ts)
常量文件: UPPER_SNAKE_CASE (如: API_CONSTANTS.ts)
```

### 1.2 组件规范
```typescript
// 组件定义
interface ComponentProps {
  title: string;
  onClose?: () => void;
  children?: React.ReactNode;
}

const Component: React.FC<ComponentProps> = ({ 
  title, 
  onClose, 
  children 
}) => {
  // 状态定义
  const [loading, setLoading] = useState(false);
  
  // 副作用
  useEffect(() => {
    // 副作用逻辑
  }, []);
  
  // 事件处理
  const handleClick = useCallback(() => {
    // 处理逻辑
  }, []);
  
  return (
    <div>
      <h1>{title}</h1>
      {children}
    </div>
  );
};

export default Component;
```

### 1.3 样式规范
```typescript
// 使用CSS Modules或styled-components
// 避免内联样式
const styles = {
  container: {
    padding: '16px',
    backgroundColor: '#fff',
  },
  title: {
    fontSize: '18px',
    fontWeight: 'bold',
  },
};
```

### 1.4 API调用规范
```typescript
// 使用统一的API服务
import { apiService } from '@/services/api';

// 错误处理
const fetchData = async () => {
  try {
    setLoading(true);
    const response = await apiService.get('/logs');
    setData(response.data);
  } catch (error) {
    message.error('获取数据失败');
  } finally {
    setLoading(false);
  }
};
```

## 2. 后端代码规范

### 2.1 包结构规范
```
com.security.ailogsystem
├── controller/     # 控制器层
├── service/        # 服务层
├── repository/     # 数据访问层
├── model/          # 实体类
├── dto/            # 数据传输对象
├── config/         # 配置类
├── exception/      # 异常处理
├── util/           # 工具类
└── constant/       # 常量类
```

### 2.2 类命名规范
```java
// 控制器
@RestController
@RequestMapping("/api/logs")
public class LogController {
    // 方法命名: 动词 + 名词
    public ResponseEntity<LogEntryDTO> getLogById(@PathVariable Long id) {
        // 实现
    }
}

// 服务类
@Service
public class LogService {
    // 方法命名: 动词 + 名词
    public LogEntryDTO createLog(LogEntryDTO logEntryDTO) {
        // 实现
    }
}

// 实体类
@Entity
@Table(name = "log_entries")
public class LogEntry {
    // 字段命名: camelCase
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(name = "log_level")
    private String level;
}
```

### 2.3 注解使用规范
```java
// 控制器注解
@RestController
@RequestMapping("/api/logs")
@Validated
@Slf4j
public class LogController {
    
    @GetMapping("/{id}")
    @ApiOperation("获取日志详情")
    public ResponseEntity<LogEntryDTO> getLogById(
        @PathVariable @NotNull Long id
    ) {
        // 实现
    }
}

// 服务注解
@Service
@Transactional
@Slf4j
public class LogService {
    
    @Cacheable(value = "logs", key = "#id")
    public LogEntryDTO getLogById(Long id) {
        // 实现
    }
}
```

### 2.4 异常处理规范
```java
// 自定义异常
public class BusinessException extends RuntimeException {
    private final String code;
    private final String message;
    
    public BusinessException(String code, String message) {
        super(message);
        this.code = code;
        this.message = message;
    }
}

// 全局异常处理
@RestControllerAdvice
@Slf4j
public class GlobalExceptionHandler {
    
    @ExceptionHandler(BusinessException.class)
    public ResponseEntity<ErrorResponse> handleBusinessException(
        BusinessException e
    ) {
        log.error("业务异常: {}", e.getMessage(), e);
        return ResponseEntity.badRequest()
            .body(new ErrorResponse(e.getCode(), e.getMessage()));
    }
}
```

## 3. 数据库规范

### 3.1 表命名规范
```
表名: snake_case，复数形式
字段名: snake_case
索引名: idx_表名_字段名
外键名: fk_表名_字段名
```

### 3.2 字段规范
```sql
-- 主键
id BIGINT PRIMARY KEY AUTO_INCREMENT

-- 时间字段
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP

-- 软删除
deleted_at TIMESTAMP NULL

-- 状态字段
status VARCHAR(20) NOT NULL DEFAULT 'ACTIVE'

-- 外键
user_id BIGINT NOT NULL,
FOREIGN KEY (user_id) REFERENCES users(id)
```

### 3.3 索引规范
```sql
-- 主键索引
PRIMARY KEY (id)

-- 唯一索引
UNIQUE KEY uk_email (email)

-- 普通索引
KEY idx_created_at (created_at)

-- 复合索引
KEY idx_user_status (user_id, status)
```

## 4. Git提交规范

### 4.1 提交信息格式
```
<type>(<scope>): <subject>

<body>

<footer>
```

### 4.2 类型说明
- feat: 新功能
- fix: 修复bug
- docs: 文档更新
- style: 代码格式调整
- refactor: 代码重构
- test: 测试相关
- chore: 构建过程或辅助工具的变动

### 4.3 示例
```
feat(logs): 添加日志批量导入功能

- 支持CSV格式文件导入
- 添加数据验证和错误处理
- 提供导入进度显示

Closes #123
```

## 5. 测试规范

### 5.1 单元测试
```java
@ExtendWith(MockitoExtension.class)
class LogServiceTest {
    
    @Mock
    private LogRepository logRepository;
    
    @InjectMocks
    private LogService logService;
    
    @Test
    @DisplayName("根据ID获取日志应该返回正确结果")
    void getLogById_ShouldReturnCorrectResult() {
        // Given
        Long id = 1L;
        LogEntry expectedLog = new LogEntry();
        when(logRepository.findById(id)).thenReturn(Optional.of(expectedLog));
        
        // When
        LogEntryDTO result = logService.getLogById(id);
        
        // Then
        assertThat(result).isNotNull();
        verify(logRepository).findById(id);
    }
}
```

### 5.2 集成测试
```java
@SpringBootTest
@AutoConfigureTestDatabase
@TestPropertySource(locations = "classpath:application-test.properties")
class LogControllerIntegrationTest {
    
    @Autowired
    private TestRestTemplate restTemplate;
    
    @Test
    void getLogs_ShouldReturnLogList() {
        // Given
        String url = "/api/logs";
        
        // When
        ResponseEntity<PageDTO<LogEntryDTO>> response = 
            restTemplate.getForEntity(url, PageDTO.class);
        
        // Then
        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.OK);
    }
}
```

## 6. 性能规范

### 6.1 前端性能
- 使用React.memo避免不必要的重渲染
- 使用useMemo和useCallback优化计算
- 实现虚拟滚动处理大数据列表
- 图片懒加载和压缩

### 6.2 后端性能
- 使用数据库索引优化查询
- 实现分页查询避免大数据量
- 使用缓存减少数据库访问
- 异步处理耗时操作

## 7. 安全规范

### 7.1 输入验证
```java
@Valid
public class LogEntryDTO {
    @NotBlank(message = "日志级别不能为空")
    @Pattern(regexp = "INFO|WARN|ERROR|DEBUG", message = "日志级别格式不正确")
    private String level;
    
    @Size(max = 1000, message = "日志消息长度不能超过1000字符")
    private String message;
}
```

### 7.2 SQL注入防护
```java
// 使用参数化查询
@Query("SELECT l FROM LogEntry l WHERE l.level = :level")
List<LogEntry> findByLevel(@Param("level") String level);

// 避免字符串拼接
// 错误示例: "SELECT * FROM logs WHERE level = '" + level + "'"
```

### 7.3 XSS防护
```java
// 输出转义
@JsonSerialize(using = XssStringJsonSerializer.class)
private String content;
```

## 8. 文档规范

### 8.1 代码注释
```java
/**
 * 根据日志级别和时间范围查询日志
 * 
 * @param level 日志级别，不能为空
 * @param startTime 开始时间
 * @param endTime 结束时间
 * @param pageable 分页参数
 * @return 日志分页结果
 * @throws IllegalArgumentException 当level为空时抛出
 */
public Page<LogEntry> findByLevelAndTimeRange(
    String level, 
    LocalDateTime startTime, 
    LocalDateTime endTime, 
    Pageable pageable
) {
    // 实现
}
```

### 8.2 API文档
```java
@ApiOperation(value = "获取日志列表", notes = "支持分页和条件查询")
@ApiResponses({
    @ApiResponse(code = 200, message = "成功"),
    @ApiResponse(code = 400, message = "参数错误"),
    @ApiResponse(code = 500, message = "服务器错误")
})
@GetMapping
public ResponseEntity<PageDTO<LogEntryDTO>> getLogs(
    @ApiParam("页码") @RequestParam(defaultValue = "0") int page,
    @ApiParam("每页数量") @RequestParam(defaultValue = "20") int size
) {
    // 实现
}
```
