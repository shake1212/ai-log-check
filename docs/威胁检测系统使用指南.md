# 威胁检测和告警生成系统使用指南

## 系统概述

威胁检测和告警生成系统是一个智能化的安全防护系统，能够实时分析日志数据，自动检测各类安全威胁，并生成相应的安全告警。系统支持多种检测模式、自定义规则配置和智能化的响应机制。

### 主要功能

1. **多模式威胁检测**
   - 模式匹配：基于关键词和正则表达式
   - 频率检测：检测异常频率的事件
   - 阈值检测：基于数值指标的阈值判断
   - 行为分析：分析用户行为模式
   - 异常检测：识别异常活动
   - 关联分析：多条件关联检测

2. **智能告警管理**
   - 自动告警生成
   - AI置信度评估
   - 告警优先级排序
   - 告警生命周期管理
   - 误报标记和学习

3. **实时监控面板**
   - 威胁统计可视化
   - 告警趋势分析
   - 热点IP追踪
   - 实时告警通知

4. **自动化响应**
   - 仅告警
   - IP封禁
   - 账户锁定
   - 管理员通知
   - 自定义脚本执行

---

## 快速开始

### 1. 数据库初始化

运行数据库迁移脚本创建威胁检测相关表：

```bash
cd back-system/database
mysql -u root -p ai_log_system < threat_detection_tables.sql
```

该脚本会：
- 创建威胁规则表（threat_rules）
- 创建威胁告警表（threat_alerts）
- 插入10个默认检测规则
- 创建视图、存储过程和触发器
- 插入示例告警数据

### 2. 启动后端服务

```bash
cd back-system
mvn spring-boot:run
```

后端服务将在 `http://localhost:8080` 启动。

### 3. 启动前端服务

```bash
cd ai-log-system
npm install  # 首次运行
npm start
```

前端服务将在 `http://localhost:8000` 启动。

### 4. 访问系统

打开浏览器访问 `http://localhost:8000`，使用管理员账户登录：
- 用户名: admin
- 密码: admin123

---

## 核心功能使用

### 一、威胁检测规则管理

#### 1.1 访问规则管理页面

导航至：**安全管理 > 威胁检测规则** 或直接访问 `/threat-rules`

#### 1.2 查看规则列表

规则列表显示所有已配置的威胁检测规则，包括：
- 规则ID和名称
- 威胁类型
- 严重程度
- 检测模式
- 启用状态
- 触发次数
- 最后触发时间

#### 1.3 创建新规则

点击 **新建规则** 按钮，填写规则信息：

**基本信息：**
- 规则名称：唯一标识规则
- 威胁类型：选择威胁分类（SQL注入、XSS攻击等）
- 严重程度：LOW / MEDIUM / HIGH / CRITICAL
- 检测模式：选择检测方式

**检测配置：**

1. **模式匹配**（PATTERN_MATCH）
   ```json
   {
     "patterns": [
       "' or '1'='1",
       "union select",
       "drop table",
       "regex:.*<script.*>.*"
     ]
   }
   ```

2. **频率检测**（FREQUENCY）
   - 时间窗口：300秒
   - 触发阈值：5次
   ```json
   {
     "patterns": ["login failed", "authentication failed"]
   }
   ```

3. **阈值检测**（THRESHOLD）
   - 触发阈值：80
   ```json
   {
     "metric": "cpu_usage"
   }
   ```

4. **行为分析**（BEHAVIOR）
   ```json
   {
     "anomaly_indicators": ["login", "unusual hour", "new location"]
   }
   ```

**响应配置：**
- 响应动作：选择检测到威胁后的处理方式
- 目标来源：指定特定来源（留空表示所有来源）
- 优先级：0-100，数字越大优先级越高

#### 1.4 编辑和管理规则

- **编辑**：点击规则行的编辑按钮
- **启用/禁用**：使用开关按钮快速切换规则状态
- **删除**：删除不需要的规则
- **查看详情**：查看规则的完整配置信息

#### 1.5 初始化默认规则

点击 **初始化默认规则** 按钮，系统会自动创建以下默认规则：
- SQL注入检测
- XSS攻击检测
- 暴力破解检测
- 异常登录时间检测
- 恶意扫描检测
- 数据泄露检测
- 权限提升检测
- 未授权访问检测
- 命令注入检测
- DDoS攻击检测

#### 1.6 刷新检测引擎

修改规则后，点击 **刷新引擎** 按钮，使新规则立即生效。

---

### 二、威胁告警管理

#### 2.1 访问告警管理页面

导航至：**安全管理 > 威胁告警** 或直接访问 `/threat-alerts`

#### 2.2 查看告警统计

页面顶部显示关键统计指标：
- 总告警数
- 待处理告警数
- 高危告警数
- 今日新增告警

#### 2.3 搜索和筛选告警

使用搜索表单筛选告警：
- **时间范围**：选择告警发生的时间段
- **威胁类型**：筛选特定类型的威胁
- **严重程度**：筛选特定严重级别
- **状态**：筛选不同处理状态的告警
- **源IP**：查询特定IP的告警

#### 2.4 查看告警详情

点击告警ID或详情按钮，查看完整信息：
- 基本信息：告警ID、规则名称、威胁类型、严重程度
- 来源信息：来源系统、源IP、目标IP、用户账号
- AI分析：置信度、影响范围、处理建议
- 证据数据：触发告警的原始日志和匹配模式
- 处理信息：处理人、处理状态、处理备注

#### 2.5 处理告警

**快速确认：**
点击告警列表中的 **确认** 按钮，快速确认告警。

**详细处理：**
1. 点击 **处理** 按钮
2. 选择处理状态：
   - **已确认**：确认告警有效，准备处理
   - **调查中**：正在深入调查
   - **已解决**：问题已解决
   - **误报**：标记为误报
   - **已关闭**：关闭告警
3. 填写处理人
4. 填写处理备注（详细描述处理过程和结果）
5. 提交

**标记误报：**
对于误报告警，点击 **标记误报** 按钮，可以快速标记。系统会学习误报模式，优化检测准确性。

#### 2.6 批量操作

1. 在列表中选择多个告警
2. 选择批量操作：
   - 批量确认
   - 批量解决
   - 批量删除

---

### 三、实时威胁监控

#### 3.1 访问监控面板

导航至：**安全管理 > 威胁监控** 或直接访问 `/threat-monitor`

#### 3.2 查看实时指标

监控面板提供以下实时数据：

**关键指标卡片：**
- 总告警数
- 待处理告警数
- 严重/高危告警数
- 已解决告警数

**告警趋势图：**
显示选定时间范围内的告警趋势，支持按小时、天、周聚合。

**威胁类型分布：**
饼图展示各类威胁的分布情况。

**严重程度分布：**
饼图展示不同严重级别的告警分布。

**热点IP Top 10：**
显示产生告警最多的前10个IP地址，并标注风险等级。

**最近高优先级告警：**
时间轴展示最近的高优先级告警，包括：
- 告警时间
- 威胁类型和严重程度
- 告警标题和描述
- AI置信度

#### 3.3 自定义时间范围

使用页面右上角的时间选择器，可以：
- 选择预设时间范围（最近1小时、24小时、7天等）
- 自定义起止时间
- 设置自动刷新间隔（默认30秒）

#### 3.4 手动刷新

点击 **刷新** 按钮，立即更新所有监控数据。

---

## 典型使用场景

### 场景1：检测SQL注入攻击

**步骤：**
1. 创建SQL注入检测规则
2. 配置模式匹配，包含常见SQL注入特征
3. 设置严重程度为CRITICAL
4. 启用规则
5. 系统自动分析日志，检测到SQL注入时生成告警
6. 安全人员收到告警通知
7. 查看告警详情，分析证据
8. 采取防护措施
9. 标记告警为已解决

### 场景2：检测暴力破解

**步骤：**
1. 创建暴力破解检测规则
2. 选择频率检测模式
3. 设置时间窗口为300秒，阈值为5次
4. 配置模式匹配登录失败关键词
5. 启用自动响应：封禁IP
6. 系统检测到5分钟内5次登录失败
7. 自动生成告警并封禁IP
8. 安全人员确认告警
9. 查看被攻击的账户
10. 强制修改密码并解除IP封禁

### 场景3：监控异常登录

**步骤：**
1. 创建异常登录检测规则
2. 选择行为分析模式
3. 配置异常指标：非工作时间、新地点、异常设备
4. 系统分析用户登录行为
5. 检测到凌晨3点的登录行为
6. 生成告警并通知管理员
7. 联系用户确认
8. 若非本人操作，强制下线并重置密码
9. 标记告警为已解决

### 场景4：检测数据泄露

**步骤：**
1. 创建数据泄露检测规则
2. 配置模式匹配：大量数据导出、敏感表访问
3. 设置阈值检测：单次查询返回行数超过10000
4. 系统检测到异常的大批量数据查询
5. 生成高优先级告警
6. 安全人员立即查看详情
7. 分析访问日志和查询语句
8. 确认是否为数据泄露
9. 采取应急措施：暂停相关账户权限
10. 进行深入调查

---

## 系统集成

### 日志接入

威胁检测系统与日志管理系统集成，自动分析所有接入的日志数据：

```java
// 在日志接收处理中集成威胁检测
@Service
public class LogService {
    @Autowired
    private ThreatAlertService threatAlertService;
    
    public void processLog(LogEntry logEntry) {
        // 保存日志
        logRepository.save(logEntry);
        
        // 自动进行威胁检测
        List<ThreatAlert> alerts = threatAlertService.processLogAndGenerateAlerts(logEntry);
        
        // 处理生成的告警
        if (!alerts.isEmpty()) {
            // 发送通知、执行响应动作等
            handleAlerts(alerts);
        }
    }
}
```

### 告警通知

系统支持多种告警通知方式：

1. **Web界面通知**：实时在监控面板显示
2. **邮件通知**：发送详细告警邮件给管理员
3. **短信通知**：严重告警可触发短信通知
4. **WebHook**：推送告警到第三方系统

### API集成

其他系统可以通过REST API集成威胁检测功能：

```javascript
// 查询最新告警
const response = await fetch('/api/threat-detection/alerts/pending', {
  headers: {
    'Authorization': 'Bearer YOUR_TOKEN'
  }
});
const alerts = await response.json();

// 处理告警
await fetch(`/api/threat-detection/alerts/${alertId}/status`, {
  method: 'PUT',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer YOUR_TOKEN'
  },
  body: JSON.stringify({
    status: 'RESOLVED',
    assignee: '张三',
    resolution: '已处理'
  })
});
```

---

## 最佳实践

### 规则配置

1. **从默认规则开始**
   - 使用系统提供的默认规则
   - 根据实际情况调整参数
   - 逐步添加自定义规则

2. **合理设置阈值**
   - 观察正常业务模式
   - 避免设置过低导致误报
   - 避免设置过高漏掉真实威胁

3. **定期审查规则**
   - 查看规则触发统计
   - 禁用从不触发的规则
   - 优化频繁误报的规则

4. **优先级管理**
   - 高危威胁设置高优先级
   - 根据业务重要性调整优先级
   - 确保关键规则优先检测

### 告警处理

1. **及时响应**
   - 优先处理高严重度告警
   - 24小时内处理所有CRITICAL告警
   - 建立告警处理SLA

2. **准确分类**
   - 认真分析每个告警
   - 准确标记误报
   - 详细记录处理过程

3. **持续学习**
   - 分析误报模式
   - 优化检测规则
   - 分享处理经验

4. **定期清理**
   - 归档已解决的历史告警
   - 保留重要告警用于审计
   - 定期导出告警数据

### 监控运维

1. **日常监控**
   - 每日查看待处理告警
   - 关注告警趋势变化
   - 分析热点IP和异常活动

2. **定期报告**
   - 周报：总结本周威胁情况
   - 月报：分析威胁趋势和处理效果
   - 季报：评估系统运行效果

3. **性能优化**
   - 监控检测引擎性能
   - 优化规则复杂度
   - 定期清理过期数据

4. **持续改进**
   - 收集用户反馈
   - 优化检测准确性
   - 扩展检测规则库

---

## 故障排查

### 问题1：规则不触发

**可能原因：**
1. 规则未启用
2. 规则条件配置错误
3. 检测引擎缓存未刷新
4. 日志数据不匹配规则条件

**解决方案：**
1. 检查规则启用状态
2. 验证规则条件JSON格式
3. 点击"刷新引擎"按钮
4. 查看日志数据是否符合规则

### 问题2：大量误报

**可能原因：**
1. 规则阈值设置过低
2. 规则条件过于宽泛
3. 未考虑正常业务场景

**解决方案：**
1. 调高阈值或延长时间窗口
2. 优化规则条件，增加限定条件
3. 添加白名单或排除规则
4. 标记误报帮助系统学习

### 问题3：告警延迟

**可能原因：**
1. 日志接入延迟
2. 检测引擎负载过高
3. 数据库性能问题

**解决方案：**
1. 优化日志接入链路
2. 减少活跃规则数量
3. 优化数据库索引
4. 增加系统资源

---

## 技术架构

### 后端架构

```
ThreatDetectionController (REST API)
    ↓
ThreatRuleService / ThreatAlertService (业务逻辑)
    ↓
ThreatDetectionEngine (检测引擎)
    ↓
ThreatRuleRepository / ThreatAlertRepository (数据访问)
    ↓
MySQL Database (数据存储)
```

### 检测流程

```
日志接入
    ↓
LogService.processLog()
    ↓
ThreatAlertService.processLogAndGenerateAlerts()
    ↓
ThreatDetectionEngine.detectThreats()
    ↓
应用检测规则
    ├─ 模式匹配
    ├─ 频率检测
    ├─ 阈值检测
    ├─ 行为分析
    ├─ 异常检测
    └─ 关联分析
    ↓
生成ThreatAlert
    ↓
保存告警
    ↓
执行响应动作
    ↓
发送通知
```

---

## 附录

### A. 规则条件示例

**模式匹配示例：**
```json
{
  "patterns": [
    "' or '1'='1",
    "union select",
    "drop table",
    "exec(",
    "regex:.*<script.*>.*"
  ]
}
```

**频率检测示例：**
```json
{
  "patterns": [
    "login failed",
    "authentication failed",
    "invalid password"
  ]
}
```

**阈值检测示例：**
```json
{
  "metric": "request_count",
  "operator": "gt"
}
```

**行为分析示例：**
```json
{
  "anomaly_indicators": [
    "login from new location",
    "unusual hour",
    "multiple failed attempts"
  ]
}
```

**关联分析示例：**
```json
{
  "correlation_rules": [
    {
      "field": "level",
      "operator": "equals",
      "value": "ERROR"
    },
    {
      "field": "message",
      "operator": "contains",
      "value": "authentication"
    }
  ]
}
```

### B. 威胁类型说明

| 威胁类型 | 说明 | 典型特征 |
|---------|------|---------|
| SQL_INJECTION | SQL注入攻击 | 包含SQL关键词、单引号、union、drop等 |
| XSS_ATTACK | 跨站脚本攻击 | 包含<script>、javascript:、事件处理器 |
| BRUTE_FORCE | 暴力破解 | 短时间内多次登录失败 |
| ABNORMAL_LOGIN | 异常登录 | 非工作时间、异常地点、新设备登录 |
| DATA_LEAK | 数据泄露 | 大批量数据导出、敏感表访问 |
| PRIVILEGE_ESCALATION | 权限提升 | 尝试获取更高权限、sudo操作 |
| MALICIOUS_SCAN | 恶意扫描 | 大量404错误、端口扫描、目录遍历 |
| DDOS | 分布式拒绝服务 | 异常高频请求、资源耗尽 |
| UNAUTHORIZED_ACCESS | 未授权访问 | 访问被拒绝、权限不足 |
| COMMAND_INJECTION | 命令注入 | 包含系统命令、管道符、反引号 |

### C. 快捷键

| 功能 | 快捷键 |
|-----|--------|
| 刷新页面 | F5 |
| 搜索 | Ctrl + F |
| 新建规则 | Ctrl + N |
| 保存 | Ctrl + S |

---

## 联系我们

如有问题或建议，请联系：
- 技术支持邮箱：support@example.com
- 项目文档：查看项目根目录下的其他文档
- API文档：参考《威胁检测API文档.md》

---

**版本**: v1.0.0  
**更新时间**: 2024-01-15  
**作者**: AI日志异常检测系统开发团队

